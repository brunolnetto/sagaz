# CLI Examples - Correct Outbox Terminology

All examples using the correct naming convention: `--outbox-mode`, `--outbox-broker`

---

## Quick Reference

```bash
# ✅ Correct
sagaz init --outbox-mode=polling            # Default
sagaz init --outbox-mode=cdc                # High throughput
sagaz extend --enable-outbox-cdc            # Upgrade existing

# ❌ Wrong (old naming)
sagaz init --cdc-mode=cdc                   # Don't use
sagaz extend --enable-cdc                   # Don't use
```

---

## Complete Examples

### Example 1: New Project (Default Polling)

```bash
$ sagaz init --local

✓ Project initialized with outbox (polling mode)

Structure:
  docker-compose.yml     # PostgreSQL + Kafka
  .env                   # SAGAZ_OUTBOX_MODE=polling
  k8s/outbox-worker.yaml # Polling workers
```

### Example 2: New Project (CDC from Start)

```bash
$ sagaz init --local --outbox-mode=cdc --outbox-broker=kafka

✓ Project initialized with outbox (CDC mode)
✓ Debezium configured for Kafka

Structure:
  docker-compose.yml     # PostgreSQL + Kafka + Debezium
  debezium/
    kafka.properties     # Debezium connector config
  .env                   # SAGAZ_OUTBOX_MODE=cdc
  k8s/
    debezium-server.yaml
    outbox-worker.yaml   # CDC workers
```

### Example 3: Upgrade Existing Project (Safe Migration)

```bash
# Current state: polling mode
$ sagaz status
Outbox:
  Mode: Polling
  Workers: 3
  Throughput: 2,000 events/sec

# Upgrade to CDC with hybrid mode
$ sagaz extend --enable-outbox-cdc --outbox-broker=kafka --hybrid

✓ Backup created: .sagaz-backup/
✓ Added Debezium to docker-compose.yml
✓ Generated debezium/kafka.properties
✓ Created k8s/outbox-worker-cdc.yaml

Current setup:
  Polling workers: 3 (existing)
  CDC workers: 5 (new)
  Mode: Hybrid

Next steps:
  1. Start Debezium: docker-compose up -d debezium-server
  2. Monitor: sagaz status --watch
  3. Cutover: sagaz extend --remove-polling

# Start Debezium
$ docker-compose up -d debezium-server
✓ Debezium Server started

# Monitor hybrid mode
$ sagaz status
Outbox:
  Mode: Hybrid (polling + CDC)
  Workers: 3 polling, 5 CDC
  Throughput: 18,000 events/sec
    - Polling: 2,000 events/sec
    - CDC: 16,000 events/sec
  Lag: 15ms

# After validation, remove polling
$ sagaz extend --remove-polling

⚠ This will remove polling workers. Confirm? [y/N]: y

✓ Scaled down polling workers to 0
✓ Updated configuration to CDC-only mode

$ sagaz status
Outbox:
  Mode: CDC (Kafka)
  Workers: 5 CDC
  Throughput: 48,000 events/sec
  Lag: 12ms
```

### Example 4: Interactive Wizard

```bash
$ sagaz init

Welcome to Sagaz!

? Project name: my-saga-app
? Deployment type:
  > Local (Docker Compose)
    Kubernetes

? Outbox implementation:
  > Polling (simple, <5K events/sec)
    CDC (high-throughput, 50K+ events/sec)
    Hybrid (both modes, for testing)

You selected: Polling

? Message broker:
  > Kafka
    RabbitMQ
    Redis Streams

✓ Generated docker-compose.yml
✓ Generated .env (SAGAZ_OUTBOX_MODE=polling)
✓ Generated k8s/outbox-worker.yaml

Project created successfully!

Next steps:
  cd my-saga-app
  docker-compose up -d
  python examples/simple_saga.py
```

### Example 5: Configuration Validation

```bash
$ sagaz validate

Validating Outbox Configuration...

Configuration:
  Mode: CDC
  Broker: Kafka (kafka:9092)
  Workers: 5 CDC workers

Checks:
  ✓ PostgreSQL connection: OK
  ✓ PostgreSQL WAL level: logical
  ✓ Broker connectivity: OK
  ✓ Debezium status: Running
  ✓ Outbox table: saga_outbox exists
  ✓ Replication slot: sagaz_cdc active
  ✗ Outbox lag: 2500ms (threshold: 1000ms)
  ⚠ Old polling workers still deployed (3 replicas)

Errors: 1, Warnings: 1

Recommendations:
  [ERROR] High outbox lag (2500ms)
    → Scale up CDC workers:
      kubectl scale deployment/outbox-worker --replicas=10
    
    → Check Debezium logs:
      docker-compose logs debezium-server
  
  [WARNING] Polling workers still running
    → If CDC is stable, remove polling:
      sagaz extend --remove-polling

Run 'sagaz validate --fix' to auto-apply recommendations
```

### Example 6: Different Broker Types

```bash
# Kafka (default)
$ sagaz init --outbox-mode=cdc --outbox-broker=kafka

# Redis Streams (low latency)
$ sagaz init --outbox-mode=cdc --outbox-broker=redis

# RabbitMQ (flexible routing)
$ sagaz init --outbox-mode=cdc --outbox-broker=rabbitmq
```

### Example 7: Environment Variables

```bash
# .env file generated by sagaz init

# Outbox configuration
SAGAZ_OUTBOX_MODE=cdc
OUTBOX_BATCH_SIZE=100
OUTBOX_POLL_INTERVAL=1.0
OUTBOX_MAX_RETRIES=10

# CDC-specific (when mode=cdc)
OUTBOX_STREAM_NAME=saga.outbox.events
OUTBOX_CONSUMER_GROUP=sagaz-outbox-workers

# Broker configuration
SAGAZ_OUTBOX_BROKER=kafka
BROKER_TYPE=kafka
KAFKA_BOOTSTRAP_SERVERS=kafka:9092

# Database
DATABASE_URL=postgresql://postgres:pass@postgres:5432/saga_db

# Debezium (auto-configured)
DEBEZIUM_CONNECTOR_NAME=sagaz-outbox
DEBEZIUM_SNAPSHOT_MODE=initial
```

---

## Status Output Examples

### Polling Mode

```bash
$ sagaz status

Sagaz Project Status
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Outbox:
  Mode:            Polling
  Workers:         3 active
  Throughput:      2,000 events/sec
  Pending:         12 events

Broker:
  Type:            Kafka
  Endpoints:       kafka:9092
  Status:          ✓ Connected

Services:
  ✓ PostgreSQL     localhost:5432
  ✓ Kafka          localhost:9092
  ✓ Prometheus     localhost:9090
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### CDC Mode

```bash
$ sagaz status

Sagaz Project Status
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Outbox:
  Mode:            CDC (Kafka)
  Workers:         5 active
  Throughput:      48,000 events/sec
  Lag:             12ms
  Pending:         23 events

Broker:
  Type:            Kafka
  Endpoints:       kafka:9092
  Status:          ✓ Connected

Debezium:
  Status:          ✓ Running (1 replica)
  Connector:       sagaz-outbox
  Lag:             12ms
  Last sync:       2s ago

Services:
  ✓ PostgreSQL     localhost:5432
  ✓ Kafka          localhost:9092
  ✓ Debezium       localhost:8083
  ✓ Prometheus     localhost:9090
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Hybrid Mode

```bash
$ sagaz status

Sagaz Project Status
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Outbox:
  Mode:            Hybrid (polling + CDC)
  Workers:
    Polling:       3 active (2,000 events/sec)
    CDC:           5 active (16,000 events/sec)
  Total:           18,000 events/sec
  Lag:             8ms (CDC)
  Pending:         15 events

Broker:
  Type:            Kafka
  Endpoints:       kafka:9092
  Status:          ✓ Connected

Debezium:
  Status:          ✓ Running
  Connector:       sagaz-outbox
  Lag:             8ms

Services:
  ✓ PostgreSQL     localhost:5432
  ✓ Kafka          localhost:9092
  ✓ Debezium       localhost:8083
  ✓ Prometheus     localhost:9090

Note: Running in hybrid mode for migration.
      Run 'sagaz extend --remove-polling' when ready.
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## Key Takeaways

1. **Use `--outbox-mode`**, not `--cdc-mode`
2. **Use `--outbox-broker`**, not `--cdc-broker`
3. **Use `--enable-outbox-cdc`**, not `--enable-cdc`
4. Status and validation output says "Outbox", not "CDC"
5. Environment variables use `SAGAZ_OUTBOX_*` or `OUTBOX_*` prefix

**Rationale**: Outbox is the feature, CDC is the implementation.
